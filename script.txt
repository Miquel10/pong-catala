document.addEventListener('DOMContentLoaded', initGame);

function initGame() {
    // --- 1. CONFIGURACIÓ INICIAL I COMPROVACIÓ DEL CANVAS ---
    const canvas = document.getElementById('pongCanvas');

    // Comprovació de seguretat: si el canvas no es troba, atura el joc.
    if (!canvas) {
        console.error("ERROR: No es pot trobar l'element 'pongCanvas'. Assegura't que l'ID és correcte a index.html.");
        return; 
    }
    
    const ctx = canvas.getContext('2d');

    // --- 2. DADES DEL JOC ---
    const NOM_DEL_JOC = "Articles Determinats"; 
    
    // Dades del Repte Lingüístic (Exemples de noms en català)
    const NOMS_CATALANS = [
        { nom: "taula", article: "LA" },
        { nom: "gos", article: "EL" },
        { nom: "cases", article: "LES" },
        { nom: "llibres", article: "ELS" },
        { nom: "illa", article: "L'" }, 
        { nom: "home", article: "L'" },
        { nom: "pomes", article: "LES" },
        { nom: "riu", article: "EL" }
    ];

    // Opcions possibles a la pala (5 seccions per a 4 articles + apòstrof)
    const ARTICLES_PALES = ['EL', 'LA', 'ELS', 'LES', 'L\''];
    const PADDLE_SECTIONS = ARTICLES_PALES.length; // 5 seccions

    // --- 3. VARIABLES D'ESTAT ---
    let scoreEsquerra = 0;
    let scoreDreta = 0;
    let repteActual = null;

    // Objectes i dimensions del Joc
    const pala = { 
        width: 10, 
        height: canvas.height / PADDLE_SECTIONS, // 400 / 5 = 80px d'alçada per pala
        speed: 6 
    };
    
    let palaEsquerra = { x: 0, y: (canvas.height - pala.height) / 2, correctSection: 0 };
    let palaDreta = { x: canvas.width - pala.width, y: (canvas.height - pala.height) / 2, correctSection: 0 };

    let bola = { x: canvas.width / 2, y: canvas.height / 2, radius: 5, dx: 5, dy: 5, speed: 5 };

    // --- 4. FUNCIONS LINGÜÍSTIQUES I LÒGICA DE JOC ---

    function triarNouRepte() {
        const nouRepte = NOMS_CATALANS[Math.floor(Math.random() * NOMS_CATALANS.length)];
        repteActual = nouRepte;
        
        // Actualitza el missatge de repte a l'HTML
        document.getElementById('repte').innerText = `${NOM_DEL_JOC} | Troba l'article per: ${nouRepte.nom.toUpperCase()}`;
        
        // Assignar la secció correcta (índex 0 a 4) a les pales
        const indexCorrecte = ARTICLES_PALES.indexOf(nouRepte.article);
        palaEsquerra.correctSection = indexCorrecte;
        palaDreta.correctSection = indexCorrecte;
    }

    function comprovarColisioPala(palaObj) {
        const palaTop = palaObj.y;
        const seccioHeight = pala.height / PADDLE_SECTIONS;
        
        // Calcular la secció on ha impactat la pilota
        const impactY = bola.y - palaTop;
        const seccioImpactada = Math.floor(impactY / seccioHeight);

        // Comparar si la secció d'impacte conté la resposta correcta
        if (seccioImpactada === palaObj.correctSection) {
            // REBOT CORRECTE (LINGÜÍSTICAMENT VÀLID)
            bola.dx = -bola.dx;
            bola.speed += 0.2; // Augmentem velocitat lleugerament
            // Ajustar el dy per la posició d'impacte
            bola.dy = (bola.y - (palaObj.y + pala.height / 2)) * 0.3;
            return true;
        } else {
            // REBOT INCORRECTE (ERROR LINGÜÍSTIC)
            
            // El jugador perd el punt
            if (palaObj === palaEsquerra) {
                scoreDreta++;
            } else {
                scoreEsquerra++;
            }
            document.getElementById('score-esquerra').innerText = scoreEsquerra;
            document.getElementById('score-dreta').innerText = scoreDreta;

            // Reiniciar la bola i el repte
            reiniciarBola();
            return false;
        }
    }
    
    // --- 5. FUNCIONS DE DIBUIX I BUCLE ---

    function dibuixar() {
        // Fons
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Dibuixar pales i seccions
        const seccioHeight = pala.height / PADDLE_SECTIONS;
        
        for (let i = 0; i < PADDLE_SECTIONS; i++) {
            const y_seccio = i * seccioHeight;
            const y_text = y_seccio + seccioHeight / 2 + 3;
            const articleText = ARTICLES_PALES[i];

            // --- Pala Esquerra ---
            // Color: Verd si és la resposta correcta, Gris si és incorrecta
            ctx.fillStyle = i === palaEsquerra.correctSection ? '#2ECC40' : '#444'; 
            ctx.fillRect(palaEsquerra.x, palaEsquerra.y + y_seccio, pala.width, seccioHeight);
            
            // Text de l'article
            ctx.fillStyle = 'white';
            ctx.font = '7px Arial';
            ctx.fillText(articleText, palaEsquerra.x + 1, palaEsquerra.y + y_text);
            
            // --- Pala Dreta ---
            ctx.fillStyle = i === palaDreta.correctSection ? '#2ECC40' : '#444'; 
            ctx.fillRect(palaDreta.x, palaDreta.y + y_seccio, pala.width, seccioHeight);
            
            // Text de l'article
            ctx.fillStyle = 'white';
            ctx.fillText(articleText, palaDreta.x + 1, palaDreta.y + y_text);
        }
        
        // Dibuixar la Bola
        ctx.beginPath();
        ctx.arc(bola.x, bola.y, bola.radius, 0, Math.PI * 2);
        ctx.fillStyle = 'white';
        ctx.fill();
    }

    function actualitzar() {
        // Moure la Bola
        bola.x += bola.dx;
        bola.y += bola.dy;

        // Col·lisions de la Bola amb les parets superiors/inferiors
        if (bola.y + bola.radius > canvas.height || bola.y - bola.radius < 0) {
            bola.dy = -bola.dy;
        }

        // Col·lisions de la Bola amb les pales
        
        // Pala Dreta
        if (bola.x + bola.radius > palaDreta.x && 
            bola.y > palaDreta.y && bola.y < palaDreta.y + pala.height) {
            comprovarColisioPala(palaDreta);
        }

        // Pala Esquerra
        if (bola.x - bola.radius < palaEsquerra.x + pala.width && 
            bola.y > palaEsquerra.y && bola.y < palaEsquerra.y + pala.height) {
            comprovarColisioPala(palaEsquerra);
        }
        
        // Marcar punt (la bola surt pels costats)
        if (bola.x < 0 || bola.x > canvas.width) {
            if (bola.x < 0) { // Surt per l'esquerra (punt per la dreta)
                scoreDreta++;
            } else { // Surt per la dreta (punt per l'esquerra)
                scoreEsquerra++;
            }
            document.getElementById('score-esquerra').innerText = scoreEsquerra;
            document.getElementById('score-dreta').innerText = scoreDreta;

            reiniciarBola();
        }
    }

    function reiniciarBola() {
        bola.x = canvas.width / 2;
        bola.y = canvas.height / 2;
        bola.dx = (Math.random() > 0.5 ? 1 : -1) * 5; // Direcció aleatòria inicial
        bola.dy = (Math.random() * 6) - 3; // Angle inicial aleatori
        bola.speed = 5;
        triarNouRepte(); // Important: nou repte lingüístic
    }

    // --- 6. CONTROLS ---
    
    // Control de la Pala Esquerra (Ratolí)
    canvas.addEventListener('mousemove', function(e) {
        let rect = canvas.getBoundingClientRect();
        let root = document.documentElement;
        let mouseY = e.clientY - rect.top - root.scrollTop;
        
        palaEsquerra.y = mouseY - pala.height / 2; 

        // Límit superior/inferior
        if (palaEsquerra.y < 0) palaEsquerra.y = 0;
        if (palaEsquerra.y > canvas.height - pala.height) palaEsquerra.y = canvas.height - pala.height;
    });

    // Control de la Pala Dreta (Tecles)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowUp') {
            palaDreta.y -= pala.speed * 4;
        } else if (e.key === 'ArrowDown') {
            palaDreta.y += pala.speed * 4;
        }
        // Límit superior/inferior
        if (palaDreta.y < 0) palaDreta.y = 0;
        if (palaDreta.y > canvas.height - pala.height) palaDreta.y = canvas.height - pala.height;
    });


    // --- 7. BUCLE PRINCIPAL DEL JOC ---

    function loop() {
        actualitzar();
        dibuixar();
        requestAnimationFrame(loop);
    }

    // Inicialització final
    triarNouRepte();
    loop();
}
